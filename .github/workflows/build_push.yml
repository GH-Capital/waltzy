name: CI Keiyoushi Flat (Python)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_and_publish:
    name: Build & Publish (Flat Python)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Generate signing key
        run: |
          keytool -genkeypair -alias waltzy -keyalg RSA -keysize 2048 -validity 10000 -keystore signingkey.jks -storepass waltzysign -keypass waltzysign -dname "CN=waltzy"

      - name: Get signing key fingerprint
        run: |
          FINGERPRINT=$(keytool -list -v -keystore signingkey.jks -storepass waltzysign | grep "SHA256: " | head -n 1 | awk '{print $2}' | sed 's/://g' | tr '[:upper:]' '[:lower:]')
          echo "REPO_FINGERPRINT=$FINGERPRINT" >> $GITHUB_ENV

      - name: Build All Extensions
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease -x spotlessCheck -x spotlessGradleCheck --no-build-cache
        env:
          KEY_STORE_PASSWORD: waltzysign
          ALIAS: waltzy
          KEY_PASSWORD: waltzysign

      # SCRIPT PYTHON CANGGIH (PENGGANTI INSPECTOR)
      - name: Generate Repo Structure (Python)
        env:
          REPO_FINGERPRINT: ${{ env.REPO_FINGERPRINT }}
          REPO_URL: "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        run: |
          # Buat folder repo
          mkdir -p repo

          # Pindahkan APK ke repo (Flat)
          find . -name "*-release.apk" -exec cp {} repo/ \;

          # Masuk ke folder repo buat diproses
          cd repo

          # Bersihkan nama file (hapus -release)
          for file in *-release.apk; do
            mv "$file" "${file/-release.apk/.apk}"
          done

          # Jalankan Script Python Generator
          python3 -c '
          import os
          import json

          repo_data = []
          # Use dynamic URL or fallback to user provided one
          base_url = os.environ.get("REPO_URL", "https://gh-capital.github.io/waltzy/")
          fingerprint = os.environ.get("REPO_FINGERPRINT", "")

          print(f"Generating repo for {base_url}")

          for filename in sorted(os.listdir(".")):
              if filename.endswith(".apk"):
                  # Format nama file: tachiyomi-id.nama-v1.2.3.apk
                  try:
                      parts = filename.replace(".apk", "").split("-")
                      # parts contoh: ["tachiyomi", "id.Luvyaa", "v1.4.30"]

                      # Ambil data dari nama file
                      version = parts[-1].replace("v", "") # 1.4.30
                      pkg_suffix = parts[-2] # id.Luvyaa
                      lang = "all"

                      if "." in pkg_suffix:
                         lang = pkg_suffix.split(".")[0] # id

                      name_parts = pkg_suffix.split(".")
                      name = name_parts[-1].title() if len(name_parts) > 1 else name_parts[0].title() # Luvyaa
                      pkg = f"eu.kanade.tachiyomi.extension.{pkg_suffix.lower()}"

                      # Struktur JSON FLAT (Keiyoushi Style)
                      entry = {
                          "name": f"Tachiyomi: {name}",
                          "pkg": pkg,
                          "apk": filename, # Langsung nama file, tanpa folder apk/
                          "lang": lang,
                          "code": int(version.split(".")[-1]) if version.split(".")[-1].isdigit() else 1,
                          "version": version,
                          "nsfw": 0,
                          "sources": []
                      }
                      repo_data.append(entry)
                      print(f"Added: {name}")
                  except Exception as e:
                      print(f"Skipping {filename}: {e}")

          # Simpan index.min.json (Wajib buat Mihon)
          with open("index.min.json", "w") as f:
              json.dump(repo_data, f, separators=(",", ":"))

          # Simpan index.json (Versi Cantik buat Manusia)
          with open("index.json", "w") as f:
              json.dump(repo_data, f, indent=2)

          # Simpan repo.json (Wajib buat keamanan Mihon baru)
          repo_meta = {
              "name": "Manga Indo Extensions",
              "id": "waltzy-repo",
              "baseUrl": base_url,
              "formatVersion": 1,
              "signingKeyFingerprint": fingerprint
          }
          with open("repo.json", "w") as f:
              json.dump(repo_meta, f, indent=2)
          '

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Update repo (Python Flat Generator)'
